---
phase: 27.1-physics-controlled-active-piece
plan: 02
type: summary
completed: 2026-02-05
---

# Plan 27.1-02 Summary: Physics-Controlled Falling Integration

## Objective Achieved

GameEngine now reads collision state from physics to manage lock timer instead of driving falling motion itself.

## Changes Made

### Task 1: useSoftBodyPhysics Updates
**File:** `hooks/useSoftBodyPhysics.ts`

- Imported `stepActivePieceFalling` from physics.ts and `TankCell` from types
- Updated `step()` signature to accept `grid`, `gridRows`, `fallSpeed` parameters
- Added call to `stepActivePieceFalling` for active piece blobs before core physics
- Added `getActivePieceBlob()` method for reading collision state
- Exported new method in hook return value

### Task 2: GameEngine.tickActivePiece Refactored
**File:** `core/GameEngine.ts`

- Changed `tickActivePiece` from private to public
- New signature: `tickActivePiece(physicsIsColliding: boolean | null): void`
- Removed gravity/position update code (physics handles this now)
- Kept all lock timer logic unchanged (500ms normal, 50ms fast-drop, 10-reset limit)
- Added `getFallSpeed()` method (handles DENSE_GOOP + fast-drop multipliers)
- Removed internal `tickActivePiece` call from `tick()` - now called externally

### Task 3: GameBoard/Game.tsx Wiring
**Files:** `Game.tsx`, `hooks/useGameEngine.ts`, `components/GameBoard.tsx`

- `useGameEngine`: Updated physics callback to receive `engine` reference
- `Game.tsx`: Created `handlePhysicsStep` callback that:
  1. Gets fall speed from engine
  2. Calls physics.step with grid, TANK_HEIGHT, fallSpeed
  3. Gets collision state from `getActivePieceBlob()`
  4. Calls `engine.tickActivePiece(physicsIsColliding)`
- `GameBoard.tsx`: Removed position sync preStepCallback (physics owns falling now)

## Data Flow (New)

```
Game Loop (useGameEngine)
    │
    ├── engine.tick(dt)           // Game logic (NOT falling anymore)
    │
    └── handlePhysicsStep(dt, engine)
            │
            ├── engine.getFallSpeed()
            │
            ├── physics.step(dt, grid, gridRows, fallSpeed)
            │       │
            │       └── stepActivePieceFalling(blob, dt, fallSpeed, grid, gridRows)
            │               └── Updates blob.gridCells, blob.isColliding
            │
            ├── physics.getActivePieceBlob()
            │       └── Returns blob with isColliding state
            │
            └── engine.tickActivePiece(isColliding)
                    └── Manages lock timer, calls lockActivePiece() when ready
```

## Verification

- [x] `npx tsc --noEmit` passes
- [x] `npm run test:run` passes (198 tests)
- [x] Physics step receives grid and fallSpeed
- [x] GameEngine tickActivePiece uses physics collision state
- [x] Lock timer logic unchanged (500ms/50ms, 10 resets)
- [x] Position sync useEffect removed from GameBoard

## Known Limitations

- Rotation/lateral movement not synced to physics yet (Plan 27.1-03)
- Active piece blob gridCells initialized from spawn but not updated on player input
- Physics blob position may drift from game state during rotations

## Next Steps

Plan 27.1-03: Add rotation and lateral movement sync to physics blobs
