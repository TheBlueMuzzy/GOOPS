---
phase: 26.1-flatten-coordinate-system
plan: 03
type: execute
---

<objective>
Implement seam wrapping for soft-body goop so blobs seamlessly cross the cylindrical tank seam during rotation.

Purpose: When tank rotates, goops that reach the seam (columns 0/29) should visually wrap around the cylinder. This plan implements the core detection and rendering. If behavioral issues arise (floating pieces, support), a follow-up plan will add data-level splitting.

Output: Blobs visually wrap around the tank seam without visual disconnects or explosions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26.1-flatten-coordinate-system/SEAM-WRAPPING-DESIGN.md

**Key source files:**
@core/softBody/physics.ts - Has cylindricalDistanceX(), boundary constraints
@core/softBody/blobFactory.ts - Creates blobs from grid cells
@hooks/useSoftBodyPhysics.ts - Blob lifecycle, rotation handling
@components/GameBoard.tsx - SBG rendering with clipPath and render offsets

**Current state (from exploration):**
- Physics runs in unbounded X space (no wrapping during simulation) ✓
- `getBlobRenderOffsets()` detects viewport overlap at X positions [0, +900, -900] ✓
- Blobs render at multiple offsets with clipPath masking to viewport ✓
- Goo filter (`feGaussianBlur` + `feColorMatrix`) applied to blob group ✓
- When blob straddles seam, both copies rendered - should merge via goo filter

**The question:** Does the goo filter visually merge the two copies at the seam?
- If yes: Rendering is solved, need to address support/falling issues
- If no: Need path-level splitting (render partial paths at each offset)

**Key constants:**
- Tank grid: 30 columns (0-29)
- Seam columns: 0 (left edge) and 29 (right edge)
- Viewport X: -180 to +180 (in SVG coordinates)
- Cylinder width: 900 pixels
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify current seam rendering behavior</name>
  <files>components/GameBoard.tsx</files>
  <action>
Add temporary debug visualization to understand current seam behavior:

1. In the SBG rendering section (around line 639), add debug markers at seam boundaries:
   ```tsx
   {/* Debug: Seam boundary markers */}
   <line x1={-180} y1={-100} x2={-180} y2={200} stroke="red" strokeWidth="2" opacity="0.5" />
   <line x1={180} y1={-100} x2={180} y2={200} stroke="red" strokeWidth="2" opacity="0.5" />
   ```

2. In `getBlobRenderOffsets()`, add console.log when multiple offsets are returned:
   ```tsx
   if (offsets.length > 1) {
     console.log(`Blob ${blob.id} straddles seam, rendering at offsets:`, offsets);
   }
   ```

3. Ensure the goo filter parameters are tuned for seam merging:
   - Check stdDeviation on feGaussianBlur (should be ~10-25 for good merging)
   - The feColorMatrix threshold should make nearby shapes merge

This is diagnostic - we need to see what's actually happening before implementing fixes.
  </action>
  <verify>
Start dev server, play game, rotate tank to push a blob toward the edge.
Watch console for "straddles seam" messages.
Visually inspect: Do the two rendered copies merge at the red seam lines?
  </verify>
  <done>
- Debug markers show seam boundaries
- Console logs when blob straddles seam
- Visual assessment of whether goo filter merges copies
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Debug visualization for seam behavior</what-built>
  <how-to-verify>
1. Run dev server: `npm run dev -- --host`
2. Start a game, let goops lock
3. Use rotation (arrow keys or dial) to push goops toward right edge
4. Watch for console log "straddles seam"
5. Look at the visual result:

**Questions to answer:**
- Do you see TWO separate blob copies when it straddles the seam?
- Or does the goo filter merge them into one connected shape?
- Is there a visible "gap" or "line" at the seam boundary (red lines)?
- Does anything "explode" or behave badly?

**Report what you see** - this determines next steps.
  </how-to-verify>
  <resume-signal>Describe what you see: "merged nicely", "visible gap at seam", "explodes", or other observations</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Implement seam-aware path rendering (if needed)</name>
  <files>core/softBody/rendering.ts, components/GameBoard.tsx</files>
  <action>
**Only do this task if checkpoint revealed visual issues at seam.**

If goo filter doesn't merge copies well enough, implement path clipping at seam:

1. In `rendering.ts`, add `getSoftBlobPathClipped(blob, xMin, xMax)`:
   - Takes the blob vertices
   - For vertices outside [xMin, xMax], calculate intersection points with boundaries
   - Generate a closed path that stops at the boundary
   - Return the clipped path string

2. In `GameBoard.tsx`, modify rendering to use clipped paths:
   - When rendering at offset 0: clip to viewport right edge
   - When rendering at offset -900: clip to viewport left edge
   - Each copy only draws its "half" of the blob

3. Handle edge cases:
   - Blob entirely within bounds: render normally (no clipping)
   - Blob entirely outside bounds: skip rendering
   - Blob straddling: clip at boundary

**If goo filter DOES merge well:**
Skip this task - just remove the debug markers and move to support handling.
  </action>
  <verify>
Visual inspection: Seam should be invisible
No duplicate blob edges visible at seam boundary
Blob appears as one continuous shape wrapping around
  </verify>
  <done>
- Blobs render correctly at seam (either via goo filter or path clipping)
- No visible seam line or gap
- Smooth visual wrapping
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes (existing tests)
- [ ] Blobs visually wrap at seam without gaps
- [ ] No explosions or glitches at seam
- [ ] Debug markers removed (if they were temporary)
</verification>

<success_criteria>
- Blobs visually wrap around tank seam during rotation
- No visible discontinuity at seam boundary
- Existing functionality (fill, physics, merge) unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/26.1-flatten-coordinate-system/26.1-03-SUMMARY.md`

**Note:** This plan focuses on VISUAL seam wrapping. If there are BEHAVIORAL issues (floating pieces falling, support problems), create a follow-up plan 26.1-04 for linked blob support sharing.
</output>
