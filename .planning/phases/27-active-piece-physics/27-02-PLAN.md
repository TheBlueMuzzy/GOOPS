---
phase: 27-active-piece-physics
plan: 02
type: execute
---

<objective>
Render falling pieces as soft-body blobs instead of grid cells.

Purpose: Complete the visual integration so falling pieces wobble and squish with physics, and transmit impact force to locked goop on landing.

Output: Active falling pieces render as soft-body paths with goo filter, matching locked goop visual style.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-active-piece-physics/27-01-SUMMARY.md (after plan 01 complete)

**Key source files:**
@components/GameBoard.tsx (active piece rendering: lines 978-1019)
@core/softBody/rendering.ts (getSoftBlobPath, getInsetPath)
@hooks/useSoftBodyPhysics.ts

**Context from plan 01:**
- Falling blobs are created on spawn and removed on lock
- Blob position syncs with piece movement
- Blobs have `isFalling: true`, `fillAmount: 1`

**Key rendering patterns (from locked goop):**
- Desktop only (skip on isMobile for performance)
- Use goo filter: `filter="url(#goo-filter)"`
- Wrap in `clipPath="url(#tank-viewport-clip)"`
- Handle cylindrical wrapping via getBlobRenderOffsets()
- Use getSoftBlobPath() for smooth Catmull-Rom splines

**Falling blob visual differences from locked:**
- fillAmount = 1 (fully filled, no wall animation needed)
- No viscosity (snappy response)
- Slightly more opacity (0.8 vs locked goop)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add soft-body rendering for falling blobs</name>
  <files>components/GameBoard.tsx</files>
  <action>
Add a new rendering section for falling blobs (after the locked goop SBG rendering, before the grid-cell active piece rendering):

1. Find the section that renders locked goop SBG (around lines 686-827).

2. After that section, add a new block for falling blobs:

```typescript
{/* Soft-body falling pieces (desktop only) */}
{!isMobile && softBodyPhysics && (() => {
  // Find all falling blobs
  const fallingBlobs = softBodyPhysics.blobs.filter(b => b.isFalling && !b.isLocked);
  if (fallingBlobs.length === 0) return null;

  return (
    <g filter="url(#goo-filter)" clipPath="url(#tank-viewport-clip)">
      {fallingBlobs.map(blob => {
        // Get render offsets for cylindrical wrapping
        const offsets = getBlobRenderOffsets(blob);

        return offsets.map((offset, idx) => {
          const path = getSoftBlobPath(blob, offset);
          if (!path) return null;

          return (
            <path
              key={`falling-${blob.id}-${idx}`}
              d={path}
              fill={blob.color}
              fillOpacity={0.8}
              stroke="white"
              strokeWidth="2"
            />
          );
        });
      })}
    </g>
  );
})()}
```

3. Keep the existing grid-cell active piece rendering as a FALLBACK for mobile:

Update the existing active piece render condition (around line 979) to only run on mobile:

```typescript
{/* Active Piece - Grid cells (mobile fallback only) */}
{isMobile && activeGoop && activeGoop.state === GoopState.FALLING && (() => {
  // ... existing grid-cell rendering code ...
})()}
```

What to avoid and WHY:
- Don't remove the grid-cell rendering entirely — keep it for mobile fallback
- Don't apply viscosity to falling blobs — they should be snappy
- Don't use wall/fill animation for falling — they're already "full"
  </action>
  <verify>
Desktop: Start game, falling piece should render as soft-body blob with goo effect.
Mobile: Falling piece should still render as grid cells (fallback).
  </verify>
  <done>Falling pieces render as soft-body blobs on desktop, grid cells on mobile</done>
</task>

<task type="auto">
  <name>Task 2: Handle wild pieces and multi-color pieces</name>
  <files>components/GameBoard.tsx</files>
  <action>
Handle special piece types in the falling blob rendering:

1. **Wild pieces**: Apply the same rainbow gradient animation used for locked wild goop.

Check if the piece is wild via `activeGoop.definition.isWild`. If wild:
- Use the `wild-fill` CSS class or animated gradient
- Currently locked wild goop uses `getWildColorAtX()` for position-based color

For falling wild blobs, apply the wild-stroke class to the path:
```typescript
className={isWild ? "wild-stroke wild-fill" : undefined}
```

2. **Multi-color pieces**: The blob factory already uses the first cell's color. This is acceptable for Phase 27 — true multi-color blob rendering would require splitting into multiple blobs (future enhancement).

Add a note in the code:
```typescript
// TODO Phase 28+: Multi-color pieces render as single-color blob using first cell color.
// True multi-color rendering would require splitting into separate blobs per color.
```

3. Check if wild classes exist. If not, add minimal styles:
```css
.wild-fill {
  fill: url(#wild-gradient);
}
.wild-stroke {
  stroke: url(#wild-gradient);
}
```

Note: The wild gradient definition (#wild-gradient) should already exist in the SVG defs for locked goop.

What to avoid and WHY:
- Don't create separate blobs per cell color for multi-color pieces — too complex for this phase
- Don't break wild piece visuals — they should look consistent with locked wild goop
  </action>
  <verify>
Test wild piece (rank 40+): Should render with rainbow effect, matching locked wild goop style.
Test multi-color piece (rank 20+): Should render as single color (first cell's color) - acceptable.
  </verify>
  <done>Wild pieces render with correct rainbow effect, multi-color pieces handled gracefully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Active falling pieces now render as soft-body blobs with physics</what-built>
  <how-to-verify>
    1. Run: `npm run dev -- --host`
    2. Start a game at rank 0+ (any rank works)
    3. OBSERVE falling piece:
       - Should be a gooey blob shape (not grid rectangles)
       - Should wobble slightly as it falls
       - Should have white outline and goo blur effect
    4. Let piece land on locked goop:
       - **KEY TEST**: Locked goop should jiggle/bounce when piece impacts
       - This tests the stiffness behavior from UAT-001
    5. Rotate the tank while piece is falling:
       - Blob should stay visually aligned with piece position
    6. Test on mobile (phone or responsive mode):
       - Should fall back to grid-cell rendering (no SBG)

    **Expected behaviors:**
    - Falling blob matches shape of piece (L-shape, T-shape, etc.)
    - Landing impact causes visible wobble in locked goop below
    - No visual glitches at tank edges (cylindrical wrapping)
    - Performance stays smooth (60fps on desktop)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] Desktop: Falling pieces render as soft-body blobs
- [ ] Mobile: Falling pieces render as grid cells (fallback)
- [ ] Landing impact transmits force to locked goop (jiggle visible)
- [ ] Wild pieces render with rainbow effect
- [ ] Tank rotation doesn't break falling blob position
- [ ] No duplicate rendering (SBG + grid cells)
</verification>

<success_criteria>

- All tasks completed
- Human verification approved
- Falling pieces use soft-body physics visually
- Impact force transfers to locked goop on landing
- Phase 27 complete
</success_criteria>

<output>
After completion, create `.planning/phases/27-active-piece-physics/27-02-SUMMARY.md`:

# Phase 27 Plan 02: Falling Piece Rendering Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions]

## UAT Findings (Stiffness)

[Document whether UAT-001/UAT-002 are now resolved with impact force visible]

## Next Phase Readiness

Phase 27 complete, ready for Phase 28 (Locked Goop Behavior)
</output>
