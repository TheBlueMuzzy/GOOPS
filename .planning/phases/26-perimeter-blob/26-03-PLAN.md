---
phase: 26-perimeter-blob
plan: 03
type: execute
---

<objective>
Replace old goop rendering with soft-body blobs and add fill animation.

Purpose: Complete the transition from static grid-aligned rendering to dynamic soft-body rendering with proper fill animation.
Output: Locked goop renders exclusively via soft-body system with fill animation intact.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@.planning/phases/26-perimeter-blob/26-03-SUMMARY.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summaries:
@.planning/phases/26-perimeter-blob/26-01-SUMMARY.md
@.planning/phases/26-perimeter-blob/26-02-SUMMARY.md

# Key source files:
@src/components/GameBoard.tsx
@src/hooks/useSoftBodyPhysics.ts
@src/core/softBody/types.ts

**Current state (from 26-02):**
- Both old and new rendering active (comparison mode)
- Soft-body blobs created for goopGroupIds
- Goo filter working

**Fill animation system:**
- Current: Time-based fill from timestamp (PER_BLOCK_DURATION = 50ms/block)
- Blobs have fillAmount property (0 to 1)
- Need to animate fillAmount over time
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fill animation to soft-body blobs</name>
  <files>src/components/GameBoard.tsx, src/hooks/useSoftBodyPhysics.ts</files>
  <action>
Implement fill animation for soft-body blobs.

**Option A: Time-based fill in hook** (simpler, matches current system)

In useSoftBodyPhysics.ts, add fill animation update to step():

```tsx
const step = useCallback((dt: number) => {
  if (!enabled || blobsRef.current.length === 0) return;

  // Run physics
  stepPhysics(blobsRef.current, dt, paramsRef.current, boundsRef.current);

  // Update fill animation for locked blobs
  const fillRate = 0.02; // ~2% per frame at 60fps = ~0.8s to fill
  for (const blob of blobsRef.current) {
    if (blob.isLocked && blob.fillAmount < 1) {
      blob.fillAmount = Math.min(1, blob.fillAmount + fillRate * dt * 60);
    }
  }
}, [enabled]);
```

**In GameBoard.tsx, use fillAmount for rendering:**

Update the blob path rendering to show fill progress:

```tsx
{softBodyPhysics.blobs.map(blob => {
  const fillHeight = blob.fillAmount; // 0 to 1
  return (
    <g key={`soft-${blob.id}`}>
      {/* Background (dim) */}
      <path
        d={getBlobVertexPath(blob)}
        fill={blob.color}
        fillOpacity={0.2}
      />
      {/* Filled portion (use clipPath for bottom-up fill) */}
      <defs>
        <clipPath id={`fill-clip-${blob.id}`}>
          <rect
            x={getBlobBounds(blob).minX}
            y={getBlobBounds(blob).maxY - (getBlobBounds(blob).maxY - getBlobBounds(blob).minY) * fillHeight}
            width={getBlobBounds(blob).maxX - getBlobBounds(blob).minX}
            height={(getBlobBounds(blob).maxY - getBlobBounds(blob).minY) * fillHeight}
          />
        </clipPath>
      </defs>
      <path
        d={getBlobVertexPath(blob)}
        fill={blob.color}
        fillOpacity={0.9}
        clipPath={`url(#fill-clip-${blob.id})`}
      />
      {/* Outline */}
      <path
        d={getBlobVertexPath(blob)}
        fill="none"
        stroke={blob.color}
        strokeWidth="2"
        className="glow-stroke"
      />
    </g>
  );
})}
```

Add helper to get blob bounds:

```tsx
function getBlobBounds(blob: SoftBlob): { minX: number; maxX: number; minY: number; maxY: number } {
  const xs = blob.vertices.map(v => v.pos.x);
  const ys = blob.vertices.map(v => v.pos.y);
  return {
    minX: Math.min(...xs),
    maxX: Math.max(...xs),
    minY: Math.min(...ys),
    maxY: Math.max(...ys),
  };
}
```

This creates a bottom-up fill effect matching the current system.
  </action>
  <verify>
1. `npm run build` passes
2. Lock a piece - fill animation runs from bottom to top
3. Fill takes ~1 second to complete
  </verify>
  <done>Fill animation working on soft-body blobs</done>
</task>

<task type="auto">
  <name>Task 2: Remove old goop rendering for desktop</name>
  <files>src/components/GameBoard.tsx</files>
  <action>
Conditionally disable old goop rendering when soft-body is active.

Find the existing goop group rendering section (around lines 351-482) and wrap it:

```tsx
{/* Legacy goop rendering (mobile only when soft-body active) */}
{(isMobile || softBodyPhysics.blobs.length === 0) && (
  // ... existing goop rendering code ...
)}
```

This means:
- Mobile: Always uses old rendering
- Desktop with no blobs: Uses old rendering (fallback)
- Desktop with blobs: Uses soft-body rendering exclusively

**Also ensure the soft-body rendering section is complete:**

```tsx
{/* Soft-body blob rendering (desktop only) */}
{!isMobile && softBodyPhysics.blobs.length > 0 && (
  <g filter="url(#goo-filter)">
    {/* Full blob rendering with fill animation */}
  </g>
)}
```

Make sure glow-stroke class is applied to blob outlines for consistency with old rendering.
  </action>
  <verify>
1. `npm run build` passes
2. Desktop: Only soft-body blobs visible (no duplicate rendering)
3. Mobile: Old rendering still works
  </verify>
  <done>
- Desktop uses soft-body rendering exclusively
- Mobile uses legacy rendering
- No duplicate rendering
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete soft-body goop rendering with fill animation</what-built>
  <how-to-verify>
    1. Run: `npm run dev -- --host`
    2. Open on desktop: http://localhost:5173/GOOPS/
    3. Start a game
    4. Lock a piece - verify:
       - Blob appears with soft edges (goo filter)
       - Fill animation runs from bottom to top
       - Outline has glow effect
    5. Lock multiple pieces of same color adjacent:
       - Blobs should appear for each group
       - Groups with same goopGroupId render as single blob
    6. Compare visual quality to old rendering
    7. Check mobile (or narrow browser) still works with old rendering
    8. Play for 30+ seconds - verify no performance issues
  </how-to-verify>
  <resume-signal>Type "approved" if rendering looks good, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm run test:run` passes all tests
- [ ] Desktop: Soft-body blobs with fill animation
- [ ] Desktop: Goo filter creates smooth edges
- [ ] Mobile: Legacy rendering unchanged
- [ ] No console errors or performance issues
</verification>

<success_criteria>
- Fill animation works (bottom-up, ~1s duration)
- Old rendering disabled on desktop when soft-body active
- Glow effect on blob outlines
- Mobile unchanged
- Phase 26 complete: Perimeter & Blob System functional
</success_criteria>

<output>
After completion, create `.planning/phases/26-perimeter-blob/26-03-SUMMARY.md`:

# Phase 26 Plan 03: Fill Animation & Rendering Cutover Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 26 complete. Ready for Phase 27: Active Piece Physics.
</output>
