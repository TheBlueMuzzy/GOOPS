---
phase: 26-perimeter-blob
plan: 02
type: execute
---

<objective>
Render soft-body blobs for locked goop groups, replacing static path rendering.

Purpose: Transform the visual rendering of locked goop from static grid-aligned shapes to dynamic soft-body blobs that wobble and deform.
Output: Locked goop groups render as soft-body blobs with goo filter applied (desktop only).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@.planning/phases/26-perimeter-blob/26-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summary:
@.planning/phases/26-perimeter-blob/26-01-SUMMARY.md

# Key source files:
@src/components/GameBoard.tsx
@src/utils/goopRenderer.ts
@src/core/softBody/blobFactory.ts
@src/hooks/useSoftBodyPhysics.ts

**Tech stack available:**
- Goo filter defined in defs (from 26-01)
- Physics hook integrated (from 26-01)
- createBlobFromCells for perimeter tracing

**Established patterns:**
- Physics runs in flat pixel space
- goopGroupId groups cells together
- buildRenderableGroups() returns Map<groupId, RenderableCell[]>

**Current rendering flow:**
1. buildRenderableGroups() scans grid for goopGroupIds
2. For each group: mask (getBlobPath) + fill animation + contour (getContourPath)
3. Desktop uses masks, mobile uses simplified rects
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create soft-body blob sync function</name>
  <files>src/components/GameBoard.tsx</files>
  <action>
Create a function to sync game state (goopGroupIds) with soft-body blobs.

This function:
1. Gets current goopGroupIds from the grid
2. Creates blobs for new groups (not yet tracked)
3. Removes blobs for groups that no longer exist
4. Updates existing blob positions if grid changed

Add this helper function inside GameBoard (or in a new utils file):

```tsx
/**
 * Sync soft-body blobs with current grid state.
 * Called after game state changes.
 */
function syncSoftBodyBlobs(
  engine: GameEngine,
  physics: ReturnType<typeof useSoftBodyPhysics>
) {
  const grid = engine.getGrid();
  const groups = new Map<string, { cells: Vec2[]; color: string }>();

  // 1. Collect current goopGroupIds from grid
  for (let y = 0; y < TANK_VIEWPORT_HEIGHT; y++) {
    for (let visX = 0; visX < TANK_VIEWPORT_WIDTH; visX++) {
      const x = (engine.getRotation() + visX) % TANK_WIDTH;
      const cell = grid[x]?.[y];
      if (cell?.goopGroupId) {
        const groupId = cell.goopGroupId;
        if (!groups.has(groupId)) {
          groups.set(groupId, { cells: [], color: cell.color });
        }
        groups.get(groupId)!.cells.push({ x: visX, y });
      }
    }
  }

  // 2. Create blobs for new groups
  const existingIds = new Set(physics.blobs.map(b => b.id));
  for (const [groupId, data] of groups) {
    if (!existingIds.has(groupId)) {
      physics.createBlob(data.cells, data.color, groupId, true);
    }
  }

  // 3. Remove blobs for groups that no longer exist
  const currentIds = new Set(groups.keys());
  for (const blob of physics.blobs) {
    if (!currentIds.has(blob.id)) {
      physics.removeBlob(blob.id);
    }
  }
}
```

Import Vec2 from soft-body types if not already imported.

Call this function in the render method or useEffect when engine state changes.

**Note:** This is a first-pass sync. More sophisticated merging (preserving momentum) will come in later phases.
  </action>
  <verify>TypeScript compiles without errors: `npm run build`</verify>
  <done>syncSoftBodyBlobs function created and called on state changes</done>
</task>

<task type="auto">
  <name>Task 2: Render soft-body blobs as SVG paths</name>
  <files>src/components/GameBoard.tsx</files>
  <action>
Add rendering for soft-body blobs using their vertex positions.

1. Create a helper to generate SVG path from blob vertices:

```tsx
/**
 * Generate SVG path string from soft-body blob vertices.
 */
function getBlobVertexPath(blob: SoftBlob): string {
  const verts = blob.vertices;
  if (verts.length < 3) return '';

  // Start at first vertex
  let path = `M ${verts[0].pos.x} ${verts[0].pos.y}`;

  // Line to each subsequent vertex
  for (let i = 1; i < verts.length; i++) {
    path += ` L ${verts[i].pos.x} ${verts[i].pos.y}`;
  }

  // Close the path
  path += ' Z';
  return path;
}
```

2. In the JSX, add soft-body blob rendering (desktop only, after existing goop rendering):

```tsx
{/* Soft-body blob rendering (desktop only) */}
{!isMobile && softBodyPhysics.blobs.length > 0 && (
  <g filter="url(#goo-filter)">
    {softBodyPhysics.blobs.map(blob => (
      <path
        key={`soft-${blob.id}`}
        d={getBlobVertexPath(blob)}
        fill={blob.color}
        fillOpacity={0.8}
        stroke={blob.color}
        strokeWidth="2"
      />
    ))}
  </g>
)}
```

3. For now, render BOTH old and new systems so we can compare visually. The old rendering shows as before, soft-body blobs render on top with slight transparency.

**Important:** Keep isMobile check - mobile continues using old rendering path.
  </action>
  <verify>
1. `npm run build` passes
2. Desktop: Start game, lock a piece - should see blob shapes with goo filter
3. Mobile: Game renders as before (no soft-body)
  </verify>
  <done>
- Soft-body blobs render as SVG paths
- Goo filter applied to blob group
- Desktop shows both old and new rendering (for comparison)
- Mobile unchanged
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Soft-body blob rendering with goo filter on desktop</what-built>
  <how-to-verify>
    1. Run: `npm run dev -- --host`
    2. Open on desktop browser: http://localhost:5173/GOOPS/
    3. Start a game (any rank)
    4. Wait for a piece to lock
    5. Observe: Should see soft-body blob shape overlaid on existing goop rendering
    6. The blob should have slightly "gooey" edges from the filter
    7. Try locking multiple pieces - blobs should appear for each group
    8. On mobile (or narrow browser): Should NOT see soft-body blobs
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run test:run` passes all tests
- [ ] Desktop shows soft-body blobs with goo filter
- [ ] Mobile renders normally (no soft-body)
- [ ] No console errors
</verification>

<success_criteria>
- Soft-body blobs sync with goopGroupId state
- Blobs render as SVG paths from vertex positions
- Goo filter applied (desktop only)
- Both old and new rendering visible (comparison mode)
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/26-perimeter-blob/26-02-SUMMARY.md`:

# Phase 26 Plan 02: Soft-Body Blob Rendering Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 26-03-PLAN.md (replace old rendering with soft-body only)
</output>
