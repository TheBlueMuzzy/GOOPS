---
phase: 33-rank-0-training-sequence
plan: 04
type: execute
---

<objective>
Build the training HUD (phase name, step progress, current objective) and wire TutorialOverlay's highlight system, then verify the full training flow end-to-end.

Purpose: Training needs visual context — the player should see what phase they're in, what they need to do, and how far along they are. The highlight system (infrastructure built in Phase 31) needs activation to draw attention to specific UI elements during training steps.

Output: TrainingHUD component, wired highlight system, verified end-to-end training flow
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/31-tutorial-infrastructure/31-03-SUMMARY.md
@.planning/phases/33-rank-0-training-sequence/33-01-SUMMARY.md
@.planning/phases/33-rank-0-training-sequence/33-02-SUMMARY.md
@.planning/phases/33-rank-0-training-sequence/33-03-SUMMARY.md

# Relevant source files:
@components/TutorialOverlay.tsx
@Game.tsx
@hooks/useTrainingFlow.ts
@data/trainingScenarios.ts
@types/training.ts

**Tech stack available:**
- TrainingStep: { id, phase, name, teaches, setup, pauseGame, advance, markComplete }
- TrainingPhase: 'A' | 'B' | 'C' | 'D' | 'E' | 'F' | 'G'
- TRAINING_PHASE_NAMES: Record<TrainingPhase, string>
- TRAINING_SEQUENCE: 17 steps across 7 phases
- getNextTrainingStep(), getPhaseSteps(), isTrainingComplete()
- useTrainingFlow returns: { currentStep, isInTraining, isTrainingDone, advanceStep, completeCurrentStep }
- TutorialOverlay at z-[90], non-blocking, fade transitions, highlight infrastructure (commented out)
- Typography: t-meta (10px), t-caption (12px), t-body (18px), t-heading (24px)

**Established patterns:**
- Overlay layer pattern: absolute inset-0, z-index, pointer-events-none
- Mobile: 48px touch targets, isMobile conditional rendering
- Typography CSS classes with !important

**Constraining decisions:**
- Phase 32: 18px minimum body text, CSS !important classes
- Phase 31: Overlay is non-blocking (pointer-events-none, message box pointer-events-auto)
- Phase 33-01: Training has 7 phases (A-G), 17 steps total
- StepSetup.highlightElement: string field exists for highlighting (only A2_PERISCOPE uses it currently: 'periscope')
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build training HUD overlay</name>
  <files>components/TrainingHUD.tsx, Game.tsx</files>
  <action>
Create a new `TrainingHUD` component that displays during training:

1. **Layout**: Fixed position overlay at top of screen. Not blocking gameplay — translucent background strip. Full width, ~50-60px tall.

2. **Content**:
   - Phase name: "Phase B: Goop Basics" (from TRAINING_PHASE_NAMES[currentStep.phase])
   - Step progress: "Step 3 of 17" (calculated from TRAINING_SEQUENCE index)
   - Phase progress dots: 7 dots (one per phase A-G). Filled = all steps in that phase complete. Current = pulsing. Outline = upcoming.

3. **Styling**:
   - Use t-caption (12px) for phase label
   - Use t-body (18px) for step name (currentStep.name)
   - Phase dots: 8px circles, CSS animation for pulse on current
   - Background: semi-transparent dark strip (bg-black/60 or similar)
   - z-index: 85 (below TutorialOverlay at z-90, above game)
   - Horizontal layout: phase name left, dots center, step count right

4. **Props**:
   - `currentStep: TrainingStep` — the active training step
   - `completedStepIds: string[]` — to calculate which phases are done

5. **Wire into Game.tsx**: Show TrainingHUD only when `isInTraining` is true. Pass currentStep from useTrainingFlow. Position as a layer between game and TutorialOverlay.

6. **Phase dot logic**: A phase dot is "complete" when ALL steps in that phase are in completedStepIds (use getPhaseSteps). A phase dot is "current" when currentStep.phase matches. Otherwise it's "upcoming".

Keep it minimal — subtle persistent HUD, not flashy. CSS-only animations (no React state for per-frame updates).
  </action>
  <verify>Run `npm run test:run` — all tests pass, no TS errors</verify>
  <done>TrainingHUD component renders phase name, step progress, and 7 phase dots. Visible only during training. Styled with project typography. Pulsing animation on current phase dot.</done>
</task>

<task type="auto">
  <name>Task 2: Wire TutorialOverlay highlight system</name>
  <files>components/TutorialOverlay.tsx</files>
  <action>
Enable the highlight area infrastructure from Phase 31 (currently commented out in TutorialOverlay.tsx):

1. **Uncomment/implement the clip-path cutout system**. The pattern should be: when a highlight region is defined, the overlay gets a semi-transparent dark background with a rectangular "hole" cut out of it so the highlighted area is fully visible.

2. **Define highlight regions as a simple map**. Create a mapping from highlightElement strings (from StepSetup.highlightElement) to viewport regions. Currently only `A2_PERISCOPE` uses highlightElement: 'periscope'.

   Highlight definitions (approximate viewport-relative positions, will be refined during UAT):
   - `'periscope'`: The periscope drag area on the console view (center of screen, roughly 40-60% width, 30-60% height)

   For now, only implement the one highlight that exists in the data. Additional highlights can be added later by simply adding entries to the map and setting highlightElement on training steps.

3. **Implementation**: Use CSS clip-path with `polygon()` to create the cutout effect. The overlay background should be `bg-black/40` (semi-transparent) with a rectangular hole where the highlight is. When no highlight is defined, the overlay should remain fully transparent (non-blocking, current behavior).

4. **Accept highlightElement as a prop** on TutorialOverlay (or derive it from the current training step). The highlight should appear when the step has `setup.highlightElement` defined and disappear on step change.

Keep it simple — rectangular cutouts only, no rounded corners or complex shapes. The point is directional attention, not polish.
  </action>
  <verify>Run `npm run test:run` — all tests pass, no TS errors</verify>
  <done>Highlight system active. A2_PERISCOPE step shows dimmed overlay with cutout around periscope area. Steps without highlights show transparent overlay (no change from current behavior). System is extensible via highlightElement map.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete rank 0 training sequence: 17 scripted steps across 7 phases with intercom messages, training HUD, highlight system, journal unlocks, and progression to rank 1</what-built>
  <how-to-verify>
    1. Clear localStorage (DevTools → Application → Clear site data) to start fresh at rank 0
    2. Start the game — should see Phase A console briefing
    3. Verify: Training HUD shows "Phase A: Console Briefing" with step progress
    4. Verify: Intercom message plays with garbled text and clear keywords (corporate trainer voice)
    5. Tap to advance A1 → A2 shows periscope highlight
    6. Drag periscope to enter tank → Phase B begins
    7. B1: Watch blue mono auto-fall. B2: Fast-fall a piece. B3: Rotate a yellow tri.
    8. C1-C3: Pop goop, watch merge, learn fill timing
    9. D1-D2: See crack, rotate tank to align goop
    10. E1-E3: Pressure rises, learn threshold mechanic, successful pop
    11. F1: Seal the green crack with green goop
    12. G1-G3: Offscreen crack, scaffolding, tradeoff lesson
    13. After G3: Training should be complete
    14. Verify: Training HUD phase dots fill in as phases complete
    15. Open journal (? button) — verify pages unlocked as training progressed (BASICS always, CONTROLS on D2, CRACKS on D1, POPPING on C3, WRAPPING on G1, SCORING on G3)
    16. Verify: Intercom messages match corporate trainer tone throughout
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all existing tests
- [ ] No TypeScript errors
- [ ] TrainingHUD renders correctly during training
- [ ] Phase dots track progress accurately (7 dots for 7 phases)
- [ ] Highlight system works for A2_PERISCOPE step
- [ ] Full training flow verified by human (checkpoint)
</verification>

<success_criteria>

- Training HUD visible and informative during all 17 steps
- Phase dots show A-G progress correctly
- Highlight system draws attention to periscope in A2 step
- Full 17-step training sequence plays through end-to-end
- Journal pages unlock as training steps with markComplete fire
- Phase 33 complete after human verification
</success_criteria>

<output>
After completion, create `.planning/phases/33-rank-0-training-sequence/33-04-SUMMARY.md`
</output>
