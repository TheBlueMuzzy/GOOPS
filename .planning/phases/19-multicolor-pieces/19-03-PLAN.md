---
phase: 19-multicolor-pieces
plan: 03
type: execute
---

<objective>
Update all rendering paths to support per-cell colors.

Purpose: Make multi-color pieces display correctly in preview, while falling, and when locked to grid.
Output: Updated PiecePreview, GameBoard falling piece rendering, and lockPieceToGrid logic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-multicolor-pieces/19-CONTEXT.md
@.planning/phases/19-multicolor-pieces/19-RESEARCH.md
@.planning/phases/19-multicolor-pieces/19-01-SUMMARY.md
@.planning/phases/19-multicolor-pieces/19-02-SUMMARY.md
@types.ts
@components/PiecePreview.tsx
@components/GameBoard.tsx
@utils/gameLogic.ts

**Key rendering points:**
- PiecePreview.tsx:38 - uses `piece.color` for all cells
- GameBoard.tsx:362 and 451 - falling piece uses `activePiece.definition.color`
- gameLogic.ts:308 and 318 - lock uses `piece.definition.color`

**Pattern:** `definition.cellColors?.[i] ?? definition.color`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PiecePreview for per-cell colors</name>
  <files>components/PiecePreview.tsx</files>
  <action>
In the pieceContent mapping (around line 31-41), change from uniform color to per-cell:

Before:
```typescript
fill={piece.color}
```

After:
```typescript
fill={piece.cellColors?.[i] ?? piece.color}
```

The `i` is already available from `.map((cell, i) => ...)`.

This handles both single-color pieces (cellColors undefined, falls back to color) and multi-color pieces (uses cellColors array).
  </action>
  <verify>npm run test:run passes</verify>
  <done>PiecePreview renders multi-color pieces correctly</done>
</task>

<task type="auto">
  <name>Task 2: Update GameBoard falling piece rendering</name>
  <files>components/GameBoard.tsx</files>
  <action>
There are two falling piece render paths in GameBoard.tsx:

1. **Non-mobile path** (around line 362-390):
   - Line 362: `const color = activePiece.definition.color;`
   - Change to get color per-cell inside the .map()

2. **Mobile path** (around line 451-480):
   - Line 451: `const color = activePiece.definition.color;`
   - Change to get color per-cell inside the .map()

For both paths, remove the `const color = ...` line before the map, and inside the map callback use:
```typescript
const color = activePiece.definition.cellColors?.[idx] ?? activePiece.definition.color;
```

The `idx` is already available from `.map((cell, idx) => ...)`.

Important: The cells array on ActivePiece changes with rotation, but cellColors is parallel to the BASE definition.cells. Need to map rotated cell back to base cell index.

Actually, looking at the code more carefully:
- `activePiece.cells` = rotated cells (changes with rotation)
- `activePiece.definition.cells` = base cells (never changes)
- `cellColors` is parallel to `definition.cells`

When we iterate over `activePiece.cells`, the index `idx` corresponds to the SAME position in `definition.cells` because rotation just transforms coordinates, doesn't reorder the array.

Wait - need to verify this. Check how getRotatedCells works in gameLogic.ts:
```typescript
return cells.map(({ x, y }) => clockwise ? { x: -y, y: x } : { x: y, y: -x });
```

Yes - it's a 1:1 map, so index is preserved. The `idx` from iterating `activePiece.cells` correctly maps to `definition.cellColors[idx]`.
  </action>
  <verify>
Manual test:
1. Start at rank 20+
2. Spawn a multi-color piece
3. Verify falling piece shows two colors
4. Rotate piece - colors should stay with their cells
5. Check both mobile and desktop rendering

npm run test:run should pass
  </verify>
  <done>Falling piece renders with per-cell colors, rotation preserves color assignment</done>
</task>

<task type="auto">
  <name>Task 3: Update lockPieceToGrid for per-cell colors</name>
  <files>utils/gameLogic.ts</files>
  <action>
In `lockPieceToGrid()` function (around line 290-328), update the cell iteration to use per-cell colors.

Find the forEach that creates grid cells (around line 300-324):

Before:
```typescript
if (hitGoal && hitGoal.color === piece.definition.color) {
  // ...
}
// ...
color: piece.definition.color,
```

After - need to use index to get per-cell color:

Change from:
```typescript
piece.cells.forEach((cell) => {
```

To:
```typescript
piece.cells.forEach((cell, idx) => {
```

Then update both places that use color:

```typescript
const cellColor = piece.definition.cellColors?.[idx] ?? piece.definition.color;

// Goal matching (line ~308):
if (hitGoal && hitGoal.color === cellColor) {

// Block creation (line ~318):
color: cellColor,
```

This ensures:
1. Goal matching checks the specific cell's color (a multi-color piece can seal cracks of both colors)
2. Locked goop has correct per-cell color
  </action>
  <verify>
Manual test:
1. At rank 20+, get a multi-color piece
2. Lock it to grid
3. Verify goop shows both colors correctly
4. Test with crack marks - each cell should seal matching color cracks

npm run test:run should pass
  </verify>
  <done>Locked goop has per-cell colors, crack matching works per-cell</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete multi-color piece system: split algorithm, spawning, preview, falling, and locked rendering</what-built>
  <how-to-verify>
    1. Run: npm run dev -- --host
    2. Start game at rank 20+ (or use debug to set rank)
    3. Verify preview (NEXT box) shows some pieces with two colors (~25%)
    4. Verify falling piece matches preview colors
    5. Rotate piece - colors stay with their cells
    6. Lock piece - goop shows both colors correctly
    7. Test with GOOP_COLORIZER - should force uniform color
    8. Test crack sealing - each cell color should match crack color to seal
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes
- [ ] Preview shows per-cell colors
- [ ] Falling piece shows per-cell colors
- [ ] Rotation preserves color-to-cell mapping
- [ ] Locked goop shows per-cell colors
- [ ] Crack sealing works per-cell
</verification>

<success_criteria>
- All tasks completed
- Human verification approved
- No TypeScript errors
- Multi-color pieces work end-to-end
- Phase 19 complete
</success_criteria>

<output>
After completion, create `.planning/phases/19-multicolor-pieces/19-03-SUMMARY.md`
</output>
