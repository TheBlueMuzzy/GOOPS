---
phase: 19-multicolor-pieces
plan: 02
type: execute
---

<objective>
Integrate multi-color splitting into piece spawning flow.

Purpose: Make 25% of pieces at rank 20+ spawn with two colors, handling the interaction with existing GOOP_COLORIZER ability.
Output: Modified GameEngine.spawnNewPiece() with split logic, GOOP_COLORIZER compatibility.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-multicolor-pieces/19-CONTEXT.md
@.planning/phases/19-multicolor-pieces/19-RESEARCH.md
@.planning/phases/19-multicolor-pieces/19-01-SUMMARY.md
@types.ts
@core/GameEngine.ts
@utils/pieceUtils.ts
@utils/gameLogic.ts

**Key points from RESEARCH.md:**
- Split happens ONCE when generating nextPiece (not at spawn)
- This ensures preview matches spawned piece
- GOOP_COLORIZER should override ALL cells to uniform color
- splitPiece() returns definition with cellColors array
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add split logic to piece generation</name>
  <files>core/GameEngine.ts</files>
  <action>
Import splitPiece from utils/pieceUtils.

In `spawnNewPiece()`, when generating nextPiece (around line 541-560), add split logic:

```typescript
// After selecting nextColor and before creating newNext:
const shouldSplit = currentRank >= 20 && Math.random() < 0.25;

let newNext: PieceDefinition;
if (shouldSplit) {
  // Pick second color different from first
  const otherColors = palette.filter(c => c !== nextColor);
  const secondColor = otherColors[Math.floor(Math.random() * otherColors.length)];

  const basePiece = {
    ...PIECES[Math.floor(Math.random() * PIECES.length)],
    color: nextColor
  };
  newNext = splitPiece(basePiece, nextColor, secondColor);
} else {
  newNext = {
    ...PIECES[Math.floor(Math.random() * PIECES.length)],
    color: nextColor
  };
}
```

Also apply same logic in startNewRun() where initial nextPiece is generated (around line 191-194).

IMPORTANT: The split is calculated ONCE when nextPiece is created, stored in the definition. When that piece spawns, the cellColors are already set.
  </action>
  <verify>
Manual test:
1. Start game at rank 20+
2. Observe nextPiece preview - some should show two colors
3. When piece spawns, colors should match preview
4. About 25% of pieces should be multi-color

Also run npm run test:run (existing tests should pass)
  </verify>
  <done>
- Split logic added to both nextPiece generation points
- Multi-color pieces appear at rank 20+
- Preview and spawn match
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle GOOP_COLORIZER with multi-color pieces</name>
  <files>core/GameEngine.ts</files>
  <action>
In spawnNewPiece(), where GOOP_COLORIZER effect is applied (around line 565-580), update to handle cellColors:

```typescript
// Apply GOOP_COLORIZER effect if active
if (this.state.colorizerRemaining > 0 && this.state.colorizerColor) {
  // Override piece color AND cellColors to uniform
  piece.definition = {
    ...piece.definition,
    color: this.state.colorizerColor,
    cellColors: undefined  // Clear multi-color, use uniform color
  };
  this.state.colorizerRemaining--;

  // Also update nextPiece if it exists (so preview shows correct color)
  if (this.state.nextPiece && this.state.colorizerRemaining > 0) {
    this.state.nextPiece = {
      ...this.state.nextPiece,
      color: this.state.colorizerColor,
      cellColors: undefined  // Clear multi-color on preview too
    };
  }
  // ... rest unchanged
}
```

Setting `cellColors: undefined` ensures the piece renders as single color (fallback to `color` field).
  </action>
  <verify>
Manual test:
1. Start game at rank 20+ with GOOP_COLORIZER equipped
2. Activate colorizer on a multi-color piece
3. Next N pieces should be uniform color (no multi-color)
4. After colorizer expires, multi-color pieces resume

npm run test:run should pass
  </verify>
  <done>
- GOOP_COLORIZER clears cellColors to force uniform color
- Preview reflects colorizer override
- Multi-color resumes after colorizer expires
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes
- [ ] Multi-color pieces appear at rank 20+ (~25% rate)
- [ ] Preview matches spawned piece colors
- [ ] GOOP_COLORIZER overrides multi-color to uniform
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Spawn logic correctly integrates split algorithm
</success_criteria>

<output>
After completion, create `.planning/phases/19-multicolor-pieces/19-02-SUMMARY.md`
</output>
